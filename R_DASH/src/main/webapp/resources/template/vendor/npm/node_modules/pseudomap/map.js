// const CTX = window.location.pathname.split('/')[1] ? `/${window.location.pathname.split('/')[1]}` : ""; 
// // 위 한 줄이 싫다면 JSP에서 '<%=request.getContextPath()%>'를 전달해 써도 됩니다.

// let map, markers = [];
// function initMap(){
//   const el = document.getElementById('map');
//   const opt = { center: new kakao.maps.LatLng(37.5665,126.9780), level: 7 };
//   map = new kakao.maps.Map(el, opt);

//   // 지도 이동 후 자동 재조회 (dust 모드일 때)
//   kakao.maps.event.addListener(map, 'idle', () => {
//     if (currentType === 'dust') fetchAndRenderDust();
//   });

//   document.getElementById('btn-dust').addEventListener('click', () => {
//     currentType = 'dust';
//     fetchAndRenderDust();
//   });

//   // 첫 렌더 보정
//   setTimeout(()=> map.relayout && map.relayout(), 60);
// }

// let currentType = null;

// async function fetchAndRenderDust(){
//   const b = map.getBounds();
//   if(!b) return;

//   const sw = b.getSouthWest(), ne = b.getNorthEast();
//   const params = new URLSearchParams({
//     minLat: sw.getLat(), maxLat: ne.getLat(),
//     minLon: sw.getLng(), maxLon: ne.getLng(),
//     limit: 800
//   });

//   // 컨텍스트 경로가 /ehr 라면 => /ehr/api/dust/bbox
//   const url = `${CTX}/api/dust/bbox?` + params.toString();

//   try{
//     const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
//     if(!res.ok) throw new Error(`HTTP ${res.status}`);
//     const rows = await res.json(); // [{lat,lon,pm10,pm25,siteName,...}, ...]

//     clearMarkers();
//     rows.forEach(r => {
//       if (r.lat == null || r.lon == null) return;
//       const marker = makeDustMarker(r);
//       marker.setMap(map);
//       markers.push(marker);

//       const iw = new kakao.maps.InfoWindow({
//         content: `<div style="padding:6px;font-size:12px">
//                     <b>${r.siteName ?? '측정소'}</b><br/>
//                     PM10: ${r.pm10 ?? '-'} / PM2.5: ${r.pm25 ?? '-'}<br/>
//                     ${r.obsTime ?? ''}
//                   </div>`
//       });
//       kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
//     });
//   }catch(e){
//     console.error(e);
//     alert('미세먼지 데이터를 불러오지 못했습니다.');
//   }
// }

// function makeDustMarker(row){
//   // 농도에 따라 원형 마커 색/크기 가볍게 바꾸기
//   const pm = Number(row.pm10 ?? 0);
//   const color = pm < 30 ? '#2ecc71' : pm < 80 ? '#f1c40f' : '#e74c3c';
//   const size = pm < 30 ? 10 : pm < 80 ? 12 : 14;

//   const div = document.createElement('div');
//   div.style.width = `${size}px`;
//   div.style.height = `${size}px`;
//   div.style.borderRadius = '50%';
//   div.style.background = color;
//   div.style.border = '2px solid white';
//   div.style.boxShadow = '0 0 0 1px rgba(0,0,0,.2)';
//   const overlay = new kakao.maps.CustomOverlay({
//     position: new kakao.maps.LatLng(Number(row.lat), Number(row.lon)),
//     content: div
//   });
//   // CustomOverlay도 setMap(map)으로 붙일 수 있게 Marker와 동일 인터페이스 맞춤
//   overlay.setMap = function(m){ kakao.maps.CustomOverlay.prototype.setMap.call(overlay, m); };
//   return overlay;
// }

// function clearMarkers(){
//   markers.forEach(m => m.setMap(null));
//   markers = [];
// }
