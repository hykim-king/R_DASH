<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.mapper.MapMapper">

    <!-- MapDTO와 1:1 -->
    <resultMap id="MapViewMap" type="com.pcwk.ehr.domain.MapDTO">
        <id     property="viewNo"     column="VIEW_NO"/>
        <result property="tableNm"    column="TABLE_NM"/>
        <result property="targetNo"   column="TARGET_NO"/>
        <result property="lat"        column="LAT"/>
        <result property="lon"        column="LON"/>
        <result property="occurDt"    column="OCCUR_DT"/>
        <result property="title"      column="TITLE"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="dangerLevel" column="DANGER_LEVEL"/>
        <result property="iconUrl"    column="ICON_URL"/>
        <result property="colorCd"    column="COLOR_CD"/>
        <result property="visualType" column="VISUAL_TYPE"/>
    </resultMap>

    <!-- ================= 레이어별 SELECT (ROWNUM 제한) ================= -->

<!-- SHELTER (문자집합 혼합 방지: 모두 TO_NCHAR로 통일) -->
<sql id="sel_shelter">
  SELECT * FROM (
    SELECT
      s.SHELTER_NO                 AS VIEW_NO,
      'SHELTER'                    AS TABLE_NM,
      s.SHELTER_NO                 AS TARGET_NO,
      s.LAT                        AS LAT,
      s.LON                        AS LON,
      NULL                         AS OCCUR_DT,
      s.SHLT_NM                    AS TITLE,
      NVL(TO_NCHAR(s.RONA_DADDR), TO_NCHAR('')) ||
      CASE WHEN s.REARE_NM IS NOT NULL
           THEN TO_NCHAR(' | 시설 ') || TO_NCHAR(s.REARE_NM)
           ELSE TO_NCHAR('')
      END                          AS DESCRIPTION,
      'INFO'                       AS DANGER_LEVEL,
      '/icons/shelter.svg'         AS ICON_URL,
      '#2E86DE'                    AS COLOR_CD,
      'MARKER'                     AS VISUAL_TYPE
    FROM SHELTER s
    WHERE
      s.LAT BETWEEN #{minLat} AND #{maxLat}
      AND s.LON BETWEEN #{minLon} AND #{maxLon}
      <if test="q != null and q != ''">
        AND (
          NLS_UPPER(TO_NCHAR(s.SHLT_NM))    LIKE '%' || NLS_UPPER(TO_NCHAR(#{q})) || '%'
          OR NLS_UPPER(TO_NCHAR(s.RONA_DADDR)) LIKE '%' || NLS_UPPER(TO_NCHAR(#{q})) || '%'
        )
      </if>
    ORDER BY s.SHELTER_NO DESC
  )
  WHERE ROWNUM &lt;= #{limit}
</sql>



    <!-- FIRE_STATION -->
    <sql id="sel_fire_station">
      SELECT * FROM (
        SELECT
          f.STATION_NO                     AS VIEW_NO,
          'FIRE_STATION'                   AS TABLE_NM,
          f.STATION_NO                     AS TARGET_NO,
          f.LAT                            AS LAT,
          f.LON                            AS LON,
          NULL                             AS OCCUR_DT,
          f.STATION_NM                     AS TITLE,
          NVL(f.AREA, '') ||
          CASE WHEN f.TEL IS NOT NULL THEN ' | ' || f.TEL ELSE '' END
                                            AS DESCRIPTION,
          'INFO'                           AS DANGER_LEVEL,
          '/icons/fire-station.svg'        AS ICON_URL,
          '#FF6B6B'                        AS COLOR_CD,
          'MARKER'                         AS VISUAL_TYPE
        FROM FIRE_STATION f
        WHERE
          f.LAT BETWEEN #{minLat} AND #{maxLat}
          AND f.LON BETWEEN #{minLon} AND #{maxLon}
          <if test="q != null and q != ''">
            AND (
              UPPER(f.STATION_NM) LIKE '%' || UPPER(#{q}) || '%'
              OR UPPER(f.AREA)    LIKE '%' || UPPER(#{q}) || '%'
            )
          </if>
        ORDER BY f.STATION_NO DESC
      )
      WHERE ROWNUM &lt;= #{limit}
    </sql>

    <!-- SINKHOLE -->
    <sql id="sel_sinkhole">
      SELECT * FROM (
        SELECT
          sk.SINKHOLE_NO                     AS VIEW_NO,
          'SINKHOLE'                         AS TABLE_NM,
          sk.SINKHOLE_NO                     AS TARGET_NO,
          sk.LAT                             AS LAT,
          sk.LON                             AS LON,
          sk.OCCUR_DT                        AS OCCUR_DT,
          COALESCE(sk.SIGNGU_NM, sk.SIDO_NM) AS TITLE,
          NVL(sk.STATE_NM, '') ||
          CASE WHEN sk.DPRS_CNT   IS NOT NULL THEN ' | 함몰 '   || sk.DPRS_CNT   ELSE '' END ||
          CASE WHEN sk.INJPSN_CNT IS NOT NULL THEN ' | 인명피해 ' || sk.INJPSN_CNT ELSE '' END
                                               AS DESCRIPTION,
          CASE
            WHEN sk.STATE_NM IN ('진행중','대응중') THEN 'WARNING'
            WHEN sk.STATE_NM IN ('조치중','조사중') THEN 'WATCH'
            ELSE 'INFO'
          END                                  AS DANGER_LEVEL,
          '/icons/sinkhole.svg'                AS ICON_URL,
          '#8E44AD'                            AS COLOR_CD,
          'MARKER'                             AS VISUAL_TYPE
        FROM SINKHOLE sk
        WHERE
          sk.LAT BETWEEN #{minLat} AND #{maxLat}
          AND sk.LON BETWEEN #{minLon} AND #{maxLon}
          <if test="q != null and q != ''">
            AND (
              UPPER(sk.SIGNGU_NM) LIKE '%' || UPPER(#{q}) || '%'
              OR UPPER(sk.SIDO_NM) LIKE '%' || UPPER(#{q}) || '%'
              OR UPPER(sk.STATE_NM) LIKE '%' || UPPER(#{q}) || '%'
            )
          </if>
          <if test="dateFrom != null and dateFrom != ''">
            AND sk.OCCUR_DT &gt;= TO_DATE(#{dateFrom},
              CASE WHEN INSTR(#{dateFrom}, ' ') &gt; 0 THEN 'YYYY-MM-DD HH24:MI' ELSE 'YYYY-MM-DD' END)
          </if>
          <if test="dateTo != null and dateTo != ''">
            AND sk.OCCUR_DT &lt; TO_DATE(#{dateTo},
              CASE WHEN INSTR(#{dateTo}, ' ') &gt; 0 THEN 'YYYY-MM-DD HH24:MI' ELSE 'YYYY-MM-DD' END) + 1
          </if>
        ORDER BY sk.OCCUR_DT DESC, sk.SINKHOLE_NO DESC
      )
      WHERE ROWNUM &lt;= #{limit}
    </sql>

   <!-- LANDSLIDE -->
<sql id="sel_landslide">
  SELECT * FROM (
    SELECT
      l.LANDSLIDE_NO                   AS VIEW_NO,
      'LANDSLIDE'                      AS TABLE_NM,
      l.LANDSLIDE_NO                   AS TARGET_NO,
      l.LAT                            AS LAT,
      l.LON                            AS LON,
      l.OCCUR_DT                       AS OCCUR_DT,
      COALESCE(l.SIGNGU_NM, l.SIDO_NM) AS TITLE,
      NVL(l.STATE_NM, '') ||
      CASE WHEN l.DAMAGE_SUM   IS NOT NULL THEN ' | 피해액 ' || l.DAMAGE_SUM   ELSE '' END ||
      CASE WHEN l.EVACUATE_CNT IS NOT NULL THEN ' | 대피 '   || l.EVACUATE_CNT ELSE '' END
                                        AS DESCRIPTION,
      CASE
        WHEN l.STATE_NM IN ('대응중','위험') THEN 'WARNING'
        WHEN l.STATE_NM IN ('주의','경계') THEN 'WATCH'
        ELSE 'INFO'
      END                               AS DANGER_LEVEL,
      '/icons/landslide.svg'            AS ICON_URL,
      '#27AE60'                         AS COLOR_CD,
      'MARKER'                          AS VISUAL_TYPE
    FROM LANDSLIDE l
    WHERE
      l.LAT BETWEEN #{minLat} AND #{maxLat}
      AND l.LON BETWEEN #{minLon} AND #{maxLon}
      <if test="q != null and q != ''">
        AND (
          UPPER(l.SIGNGU_NM)   LIKE '%' || UPPER(#{q}) || '%'
          OR UPPER(l.SIDO_NM)  LIKE '%' || UPPER(#{q}) || '%'
          OR UPPER(l.STATE_NM) LIKE '%' || UPPER(#{q}) || '%'
        )
      </if>
      <if test="dateFrom != null and dateFrom != ''">
        AND l.OCCUR_DT &gt;= TO_DATE(#{dateFrom},
          CASE WHEN INSTR(#{dateFrom}, ' ') &gt; 0 THEN 'YYYY-MM-DD HH24:MI' ELSE 'YYYY-MM-DD' END)
      </if>
      <if test="dateTo != null and dateTo != ''">
        AND l.OCCUR_DT &lt; TO_DATE(#{dateTo},
          CASE WHEN INSTR(#{dateTo}, ' ') &gt; 0 THEN 'YYYY-MM-DD HH24:MI' ELSE 'YYYY-MM-DD' END) + 1
      </if>
    ORDER BY l.OCCUR_DT DESC, l.LANDSLIDE_NO DESC
  )
  WHERE ROWNUM &lt;= #{limit}
</sql>


    <!-- DUST: 측정소별 최신 1건 -->
<!-- DUST: 측정소별 최신 1건 (TM_DATE 사용) -->
<!-- DUST: 측정소별 최신 1건 (TM_DATE 사용) -->
<!-- DUST: 측정소별 최신 1건 (TM_DATE 사용, WITH top, XML escape) -->
<sql id="sel_dust_latest">
  WITH base AS (
    SELECT
      d.STN_NM,
      d.LAT,
      d.LON,
      d.AVG,
      d.TM_DATE,
      ROW_NUMBER() OVER (PARTITION BY d.STN_NM ORDER BY d.TM_DATE DESC) rn
    FROM DUST d
    WHERE
      d.LAT BETWEEN #{minLat} AND #{maxLat}
      AND d.LON BETWEEN #{minLon} AND #{maxLon}
      <if test="dateFrom != null and dateFrom != ''">
        AND d.TM_DATE &gt;= TO_DATE(#{dateFrom},
          CASE WHEN INSTR(#{dateFrom}, ' ') &gt; 0 THEN 'YYYY-MM-DD HH24:MI' ELSE 'YYYY-MM-DD' END)
      </if>
      <if test="dateTo != null and dateTo != ''">
        AND d.TM_DATE &lt; TO_DATE(#{dateTo},
          CASE WHEN INSTR(#{dateTo}, ' ') &gt; 0 THEN 'YYYY-MM-DD HH24:MI' ELSE 'YYYY-MM-DD' END) + 1
      </if>
  )
  SELECT *
  FROM (
    SELECT
      ORA_HASH(b.STN_NM, 2147483646) AS VIEW_NO,
      'DUST'                         AS TABLE_NM,
      ORA_HASH(b.STN_NM, 2147483646) AS TARGET_NO,
      b.LAT                          AS LAT,
      b.LON                          AS LON,
      b.TM_DATE                      AS OCCUR_DT,
      b.STN_NM                       AS TITLE,
      '평균 ' || TO_CHAR(b.AVG)      AS DESCRIPTION,
      CASE
        WHEN b.AVG &gt;= 151 THEN 'DANGER'
        WHEN b.AVG &gt;=  81 THEN 'WARNING'
        WHEN b.AVG &gt;=  31 THEN 'ADVISORY'
        ELSE 'INFO'
      END                            AS DANGER_LEVEL,
      '/icons/dust.svg'              AS ICON_URL,
      '#34495E'                      AS COLOR_CD,
      'MARKER'                       AS VISUAL_TYPE
    FROM base b
    WHERE b.rn = 1
      <if test="q != null and q != ''">
        AND UPPER(b.STN_NM) LIKE '%' || UPPER(#{q}) || '%'
      </if>
    ORDER BY b.TM_DATE DESC, b.STN_NM
  )
  WHERE ROWNUM &lt;= #{limit}
</sql>



    <!-- ============= 엔트리 포인트 (레이어 분기) ============= -->
    <select id="selectMarkersByBBox" parameterType="map" resultMap="MapViewMap">
      <choose>
        <when test="layer == 'SHELTER'">
          <include refid="sel_shelter"/>
        </when>
        <when test="layer == 'FIRE_STATION'">
          <include refid="sel_fire_station"/>
        </when>
        <when test="layer == 'SINKHOLE'">
          <include refid="sel_sinkhole"/>
        </when>
        <when test="layer == 'LANDSLIDE'">
          <include refid="sel_landslide"/>
        </when>
        <when test="layer == 'DUST'">
          <include refid="sel_dust_latest"/>
        </when>
        <otherwise>
          SELECT -1 AS VIEW_NO, 'UNKNOWN' AS TABLE_NM, -1 AS TARGET_NO,
                 NULL AS LAT, NULL AS LON, NULL AS OCCUR_DT,
                 'Unsupported layer' AS TITLE, NULL AS DESCRIPTION,
                 NULL AS DANGER_LEVEL, NULL AS ICON_URL,
                 NULL AS COLOR_CD, NULL AS VISUAL_TYPE
          FROM DUAL WHERE 1=0
        </otherwise>
      </choose>
    </select>

    <!-- ============= 단건 상세 ============= -->
    <select id="findDetail" parameterType="map" resultMap="MapViewMap">
      <choose>
<when test="layer == 'SHELTER'">
  SELECT
    s.SHELTER_NO               AS VIEW_NO,
    'SHELTER'                  AS TABLE_NM,
    s.SHELTER_NO               AS TARGET_NO,
    s.LAT                      AS LAT,
    s.LON                      AS LON,
    NULL                       AS OCCUR_DT,
    s.SHLT_NM                  AS TITLE,
    NVL(TO_NCHAR(s.RONA_DADDR), TO_NCHAR('')) ||
    CASE WHEN s.REARE_NM IS NOT NULL
         THEN TO_NCHAR(' | 시설 ') || TO_NCHAR(s.REARE_NM)
         ELSE TO_NCHAR('')
    END                        AS DESCRIPTION,
    'INFO'                     AS DANGER_LEVEL,
    '/icons/shelter.svg'       AS ICON_URL,
    '#2E86DE'                  AS COLOR_CD,
    'MARKER'                   AS VISUAL_TYPE
  FROM SHELTER s
  WHERE s.SHELTER_NO = #{id}
</when>



        <when test="layer == 'FIRE_STATION'">
          SELECT
            f.STATION_NO                 AS VIEW_NO,
            'FIRE_STATION'               AS TABLE_NM,
            f.STATION_NO                 AS TARGET_NO,
            f.LAT                        AS LAT,
            f.LON                        AS LON,
            NULL                         AS OCCUR_DT,
            f.STATION_NM                 AS TITLE,
            NVL(f.AREA,'') ||
            CASE WHEN f.TEL IS NOT NULL THEN ' | ' || f.TEL ELSE '' END AS DESCRIPTION,
            'INFO'                       AS DANGER_LEVEL,
            '/icons/fire-station.svg'    AS ICON_URL,
            '#FF6B6B'                    AS COLOR_CD,
            'MARKER'                     AS VISUAL_TYPE
          FROM FIRE_STATION f
          WHERE f.STATION_NO = #{id}
        </when>

        <when test="layer == 'SINKHOLE'">
          SELECT
            sk.SINKHOLE_NO               AS VIEW_NO,
            'SINKHOLE'                   AS TABLE_NM,
            sk.SINKHOLE_NO               AS TARGET_NO,
            sk.LAT                       AS LAT,
            sk.LON                       AS LON,
            sk.OCCUR_DT                  AS OCCUR_DT,
            COALESCE(sk.SIGNGU_NM, sk.SIDO_NM) AS TITLE,
            NVL(sk.STATE_NM,'') ||
            CASE WHEN sk.DPRS_CNT   IS NOT NULL THEN ' | 함몰 '   || sk.DPRS_CNT   ELSE '' END ||
            CASE WHEN sk.INJPSN_CNT IS NOT NULL THEN ' | 인명피해 ' || sk.INJPSN_CNT ELSE '' END AS DESCRIPTION,
            CASE
              WHEN sk.STATE_NM IN ('진행중','대응중') THEN 'WARNING'
              WHEN sk.STATE_NM IN ('조치중','조사중') THEN 'WATCH'
              ELSE 'INFO'
            END                           AS DANGER_LEVEL,
            '/icons/sinkhole.svg'         AS ICON_URL,
            '#8E44AD'                     AS COLOR_CD,
            'MARKER'                      AS VISUAL_TYPE
          FROM SINKHOLE sk
          WHERE sk.SINKHOLE_NO = #{id}
        </when>

      <when test="layer == 'LANDSLIDE'">
  SELECT
    l.LANDSLIDE_NO               AS VIEW_NO,
    'LANDSLIDE'                  AS TABLE_NM,
    l.LANDSLIDE_NO               AS TARGET_NO,
    l.LAT                        AS LAT,
    l.LON                        AS LON,
    TO_DATE(l.LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS') AS OCCUR_DT,
    l.LND_INST_NM                 AS TITLE,
    NVL(l.LND_APNT_NM, '')        AS DESCRIPTION,
    CASE
      WHEN l.LND_APNT_NM IN ('대응중','위험') THEN 'WARNING'
      WHEN l.LND_APNT_NM IN ('주의','경계') THEN 'WATCH'
      ELSE 'INFO'
    END                           AS DANGER_LEVEL,
    '/icons/landslide.svg'        AS ICON_URL,
    '#27AE60'                     AS COLOR_CD,
    'MARKER'                      AS VISUAL_TYPE
  FROM LANDSLIDE l
  WHERE l.LANDSLIDE_NO = #{id}
</when>



        <when test="layer == 'DUST'">
          WITH base AS (
            SELECT
              d.STN_NM, d.LAT, d.LON, d.AVG, d.TM,
              ROW_NUMBER() OVER (PARTITION BY d.STN_NM ORDER BY d.TM DESC) rn
            FROM DUST d
          )
          SELECT
			ORA_HASH(b.STN_NM, 2147483646) AS VIEW_NO,
			'DUST'                         AS TABLE_NM,
			ORA_HASH(b.STN_NM, 2147483646) AS TARGET_NO,

            b.LAT                        AS LAT,
            b.LON                        AS LON,
            b.TM                         AS OCCUR_DT,
            b.STN_NM                     AS TITLE,
            '평균 ' || TO_CHAR(b.AVG)    AS DESCRIPTION,
            CASE
              WHEN b.AVG &gt;= 151 THEN 'DANGER'
              WHEN b.AVG &gt;=  81 THEN 'WARNING'
              WHEN b.AVG &gt;=  31 THEN 'ADVISORY'
              ELSE 'INFO'
            END                           AS DANGER_LEVEL,
            '/icons/dust.svg'            AS ICON_URL,
            '#34495E'                     AS COLOR_CD,
            'MARKER'                      AS VISUAL_TYPE
          FROM base b
          WHERE b.rn = 1 AND ABS(ORA_HASH(b.STN_NM)) = #{id}
        </when>

        <otherwise>
          SELECT -1 AS VIEW_NO, 'UNKNOWN' AS TABLE_NM, -1 AS TARGET_NO,
                 NULL AS LAT, NULL AS LON, NULL AS OCCUR_DT,
                 'Unsupported layer' AS TITLE, NULL AS DESCRIPTION,
                 NULL AS DANGER_LEVEL, NULL AS ICON_URL,
                 NULL AS COLOR_CD, NULL AS VISUAL_TYPE
          FROM DUAL WHERE 1=0
        </otherwise>
      </choose>
    </select>

    <!-- ============= 자동완성 (ROWNUM 제한) ============= -->
    <select id="suggestKeyword" parameterType="map" resultType="string">
      <choose>
        <when test="layer == 'SHELTER'">
          SELECT * FROM (
            SELECT SHLT_NM AS K
            FROM SHELTER
            WHERE SHLT_NM IS NOT NULL
            <if test="q != null and q != ''">
              AND UPPER(SHLT_NM) LIKE '%' || UPPER(#{q}) || '%'
            </if>
            GROUP BY SHLT_NM
            ORDER BY MIN(SHELTER_NO)
          )
          WHERE ROWNUM &lt;= #{limit}
        </when>

        <when test="layer == 'FIRE_STATION'">
          SELECT * FROM (
            SELECT STATION_NM AS K
            FROM FIRE_STATION
            WHERE STATION_NM IS NOT NULL
            <if test="q != null and q != ''">
              AND UPPER(STATION_NM) LIKE '%' || UPPER(#{q}) || '%'
            </if>
            GROUP BY STATION_NM
            ORDER BY MIN(STATION_NO)
          )
          WHERE ROWNUM &lt;= #{limit}
        </when>

        <when test="layer == 'SINKHOLE'">
          SELECT * FROM (
            SELECT SIGNGU_NM AS K
            FROM SINKHOLE
            WHERE SIGNGU_NM IS NOT NULL
            <if test="q != null and q != ''">
              AND UPPER(SIGNGU_NM) LIKE '%' || UPPER(#{q}) || '%'
            </if>
            GROUP BY SIGNGU_NM
            ORDER BY MIN(SINKHOLE_NO)
          )
          WHERE ROWNUM &lt;= #{limit}
        </when>

        <when test="layer == 'LANDSLIDE'">
          SELECT * FROM (
            SELECT SIGNGU_NM AS K
            FROM LANDSLIDE
            WHERE SIGNGU_NM IS NOT NULL
            <if test="q != null and q != ''">
              AND UPPER(SIGNGU_NM) LIKE '%' || UPPER(#{q}) || '%'
            </if>
            GROUP BY SIGNGU_NM
            ORDER BY MIN(LANDSLIDE_NO)
          )
          WHERE ROWNUM &lt;= #{limit}
        </when>

       <when test="layer == 'DUST'">
  WITH base AS (
    SELECT
      d.STN_NM, d.LAT, d.LON, d.AVG, d.TM_DATE,
      ROW_NUMBER() OVER (PARTITION BY d.STN_NM ORDER BY d.TM_DATE DESC) rn
    FROM DUST d
  )
  SELECT
    ORA_HASH(b.STN_NM, 2147483646) AS VIEW_NO,
    'DUST'                         AS TABLE_NM,
    ORA_HASH(b.STN_NM, 2147483646) AS TARGET_NO,
    b.LAT                          AS LAT,
    b.LON                          AS LON,
    b.TM_DATE                      AS OCCUR_DT,
    b.STN_NM                       AS TITLE,
    '평균 ' || TO_CHAR(b.AVG)      AS DESCRIPTION,
    CASE
      WHEN b.AVG >= 151 THEN 'DANGER'
      WHEN b.AVG >=  81 THEN 'WARNING'
      WHEN b.AVG >=  31 THEN 'ADVISORY'
      ELSE 'INFO'
    END                           AS DANGER_LEVEL,
    '/icons/dust.svg'            AS ICON_URL,
    '#34495E'                    AS COLOR_CD,
    'MARKER'                     AS VISUAL_TYPE
  FROM base b
  WHERE b.rn = 1 AND ORA_HASH(b.STN_NM, 2147483646) = #{id}
</when>


        <otherwise>
          SELECT 'Unsupported layer' FROM DUAL WHERE 1=0
        </otherwise>
      </choose>
    </select>

</mapper>
