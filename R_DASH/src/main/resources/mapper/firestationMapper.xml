<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.mapper.FirestationMapper">

  <!-- ResultMap -->
  <resultMap id="FirestationMap" type="com.pcwk.ehr.domain.FirestationDTO">
    <id     property="stationNo" column="STATION_NO"/>
    <result property="stationNm" column="STATION_NM"/>
    <result property="area"      column="AREA"/>
    <result property="fireNead"  column="FIRE_HEAD"/>
    <result property="tel"       column="TEL"/>
    <result property="lat"       column="LAT"/>
    <result property="lon"       column="LON"/>
    <!-- 주소 컬럼이 있으면 아래 주석 해제
    <result property="addr"      column="ADDR"/> -->
  </resultMap>

  <!-- 공통 컬럼 -->
  <sql id="cols">
    STATION_NO, STATION_NM, AREA, FIRE_HEAD, TEL, LAT, LON
  </sql>
  
  <sql id="onlySafetyCenters">
    STATION_NM LIKE '%안전센터%' OR STATION_NM LIKE '%119%'
  </sql>
  
  <sql id="region">
    COALESCE(
        REGEXP_SUBSTR(AREA, '[^ ]+ [^ ]+[시구군]'),
        REGEXP_SUBSTR(AREA, '^[^ ]+[시구군]')
    )
  </sql>

  <!-- ✅ 메인 소방서만: '소방서' 포함 & '안전센터'/'119' 미포함 -->
  <sql id="onlyMainStations">
    STATION_NM LIKE '%소방서%'
    AND STATION_NM NOT LIKE '%안전센터%'
    AND STATION_NM NOT LIKE '%119%'
  </sql>

  <!-- 1) BBox + 키워드 검색 -->
 <!-- 파라미터: fireTp (코드), fireTpLabel (한글) 둘 다 옵션 -->
  <!-- BBox -->
<!-- BBox -->
  <select id="selectByBBox" parameterType="map"
          resultType="com.pcwk.ehr.domain.FirestationDTO">
    SELECT *
    FROM (
      SELECT
        NVL(STATION_NO, 0) AS stationNo,
        STATION_NM         AS stationNm,
        AREA               AS area,
        FIRE_HEAD          AS fireNead,   -- ✅ 실제 컬럼명
        TEL                AS tel,
        NVL(LAT, 0)        AS lat,        -- NULL 방어 (DTO가 primitive double)
        NVL(LON, 0)        AS lon,
        FIRE_TP            AS fireTp
      FROM FIRE_STATION                     -- ✅ 실제 테이블명
      WHERE LAT BETWEEN #{minLat} AND #{maxLat}
        AND LON BETWEEN #{minLon} AND #{maxLon}

        <!-- 타입 필터: 코드 우선, 없으면 한글 라벨 -->
        <choose>
          <when test="fireTp != null and fireTp != '' and fireTp != 'ALL'">
            AND (
              (#{fireTp} = 'MAIN'   AND FIRE_TP = '소방서')
              OR (#{fireTp} = 'SAFETY' AND FIRE_TP = '119안전센터')
            )
          </when>
          <when test="(fireTp == null or fireTp == '' or fireTp == 'ALL')
                      and fireTpLabel != null and fireTpLabel != ''">
            AND FIRE_TP = #{fireTpLabel}
          </when>
        </choose>

      ORDER BY STATION_NO
    )
    WHERE ROWNUM &lt;= #{limit}
  </select>

  <!-- 검색 -->
  <select id="search" parameterType="map"
          resultType="com.pcwk.ehr.domain.FirestationDTO">
    SELECT *
    FROM (
      SELECT
        NVL(STATION_NO, 0) AS stationNo,
        STATION_NM         AS stationNm,
        AREA               AS area,
        FIRE_HEAD          AS fireNead,   -- ✅
        TEL                AS tel,
        NVL(LAT, 0)        AS lat,
        NVL(LON, 0)        AS lon,
        FIRE_TP            AS fireTp
      FROM FIRE_STATION                     -- ✅
      WHERE 1=1
        <if test="q != null and q != ''">
          AND (
            STATION_NM LIKE '%' || #{q} || '%'
            OR AREA     LIKE '%' || #{q} || '%'
            OR FIRE_HEAD LIKE '%' || #{q} || '%'
          )
        </if>

        <choose>
          <when test="fireTp != null and fireTp != '' and fireTp != 'ALL'">
            AND (
              (#{fireTp} = 'MAIN'   AND FIRE_TP = '소방서')
              OR (#{fireTp} = 'SAFETY' AND FIRE_TP = '119안전센터')
            )
          </when>
          <when test="(fireTp == null or fireTp == '' or fireTp == 'ALL')
                      and fireTpLabel != null and fireTpLabel != ''">
            AND FIRE_TP = #{fireTpLabel}
          </when>
        </choose>

      ORDER BY STATION_NO
    )
    WHERE ROWNUM &lt;= #{limit}
    OFFSET #{offset} ROWS
  </select>


  <!-- 3) countSearch -->
  <select id="countSearch" resultType="int">
    SELECT COUNT(1)
    FROM FIRE_STATION
    <where>
      <include refid="onlyMainStations"/>
      <if test="q != null and q != ''">
        AND (
          STATION_NM LIKE '%' || #{q} || '%'
          OR AREA       LIKE '%' || #{q} || '%'
          OR FIRE_HEAD  LIKE '%' || #{q} || '%'
        )
      </if>
      <if test="area != null and area != ''">
        AND AREA = #{area}
      </if>
      <if test="minLat != null and maxLat != null">
        AND LAT BETWEEN #{minLat} AND #{maxLat}
      </if>
      <if test="minLon != null and maxLon != null">
        AND LON BETWEEN #{minLon} AND #{maxLon}
      </if>
    </where>
  </select>

  <!-- 4) 단건 상세 (원하면 메인 소방서만 허용) -->
  <select id="selectOne" parameterType="int" resultMap="FirestationMap">
    SELECT <include refid="cols"/>
    FROM FIRE_STATION
    WHERE STATION_NO = #{stationNo}
      AND <include refid="onlyMainStations"/>
  </select>

  <!-- 5) 자동완성 - 지역 -->
  <select id="autocompleteArea" resultType="string">
    SELECT DISTINCT AREA
    FROM FIRE_STATION
    <where>
      <include refid="onlyMainStations"/>
      <if test="prefix != null and prefix != ''">
        AND AREA LIKE #{prefix} || '%'
      </if>
    </where>
    ORDER BY AREA
    FETCH FIRST
      <choose>
        <when test="limit != null"> #{limit} </when>
        <otherwise> 10 </otherwise>
      </choose>
    ROWS ONLY
  </select>

  <!-- 6) 자동완성 - 소방서명 -->
  <select id="autocompleteStation" resultType="string">
    SELECT DISTINCT STATION_NM
    FROM FIRE_STATION
    <where>
      <include refid="onlyMainStations"/>
      <if test="prefix != null and prefix != ''">
        AND STATION_NM LIKE #{prefix} || '%'
      </if>
      <if test="area != null and area != ''">
        AND AREA = #{area}
      </if>
    </where>
    ORDER BY STATION_NM
    FETCH FIRST
      <choose>
        <when test="limit != null"> #{limit} </when>
        <otherwise> 10 </otherwise>
      </choose>
    ROWS ONLY
  </select>

  <!-- 7) 시/군/구 기준 소방서 개수 (메인 소방서만 카운트) -->
  <select id="firestationCount" resultType="map">
    SELECT
      REGION,
      COUNT(*) AS FIRE_STATION_CNT
    FROM (
      SELECT DISTINCT
        COALESCE(
          REGEXP_SUBSTR(AREA, '[^ ]+ [^ ]+[시구군]'),
          REGEXP_SUBSTR(AREA, '^[^ ]+[시구군]')
        ) AS REGION,
        AREA
      FROM FIRE_STATION
      WHERE <include refid="onlyMainStations"/>
    ) t
    GROUP BY REGION
    ORDER BY REGION ASC
  </select>
  
  <select id="sigunguFireCount" resultType="map">
    SELECT r.AREA AS REGION,
           NVL(m.MAIN_CNT,0) AS MAIN_CNT,
           NVL(s.SAFE_CNT,0) AS SAFE_CNT
    FROM (
        SELECT DISTINCT <include refid="region"/> AS AREA
        FROM FIRE_STATION
    ) r
    LEFT JOIN (
        SELECT <include refid="region"/> AS REGION,
               COUNT(*) AS MAIN_CNT
        FROM FIRE_STATION
        WHERE <include refid="onlyMainStations"/>
        GROUP BY <include refid="region"/>
    ) m ON r.AREA = m.REGION
    LEFT JOIN (
        SELECT <include refid="region"/> AS REGION,
               COUNT(*) AS SAFE_CNT
        FROM FIRE_STATION
        WHERE <include refid="onlySafetyCenters"/>
        GROUP BY <include refid="region"/>
    ) s ON r.AREA = s.REGION
    ORDER BY r.AREA
  </select>

</mapper>
