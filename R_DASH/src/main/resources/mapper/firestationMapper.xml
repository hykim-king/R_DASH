<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- FIRE_STATION Mapper -->
<mapper namespace="com.pcwk.ehr.mapper.FirestationMapper">

    <!-- ResultMap -->
    <resultMap id="FireStationResultMap" type="com.pcwk.ehr.domain.FirestationDTO">
        <id     property="stationNo" column="STATION_NO"/>
        <result property="stationNm" column="STATION_NM"/>
        <result property="area"      column="AREA"/>
        <result property="fireNead"  column="FIRE_HEAD"/>
        <result property="tel"       column="TEL"/>
        <result property="lat"       column="LAT"/>
        <result property="lon"       column="LON"/>
        <result property="fireTp"    column="FIRE_TP"/>
    </resultMap>

    <!-- 공통 컬럼 -->
    <sql id="firestationColumns">
        STATION_NO,
        STATION_NM,
        AREA,
        FIRE_HEAD,
        TEL,
        LAT,
        LON,
        FIRE_TP
    </sql>

    <!-- 1) 전체 목록 -->
    <select id="selectAll" resultMap="FireStationResultMap">
        SELECT <include refid="firestationColumns"/>
        FROM FIRE_STATION
        ORDER BY STATION_NO
    </select>



    <!-- 2) 단건 조회 -->
    <select id="findById" parameterType="int" resultMap="FireStationResultMap">
        SELECT <include refid="firestationColumns"/>
        FROM FIRE_STATION
        WHERE STATION_NO = #{stationNo}
    </select>



    <!-- 6) BBox 검색 -->
    <select id="selectByBBox" parameterType="map" resultMap="FireStationResultMap">
        SELECT <include refid="firestationColumns"/>
        FROM FIRE_STATION
        <where>
            LAT BETWEEN #{minLat} AND #{maxLat}
            AND LON BETWEEN #{minLon} AND #{maxLon}
            <if test="q != null and q != ''">
                AND (
                    UPPER(AREA) LIKE '%' || UPPER(#{q}) || '%'
                    OR UPPER(STATION_NM) LIKE '%' || UPPER(#{q}) || '%'
                    OR UPPER(FIRE_HEAD) LIKE '%' || UPPER(#{q}) || '%'
                )
            </if>
        </where>
        ORDER BY STATION_NO DESC
    </select>


    <!-- 필수 기능 아님 ( 추후 구현 ) -->
    <!-- 7) 자동완성 - 지역명 -->
    <select id="suggestKeyword" parameterType="string" resultType="string">
        SELECT AREA
        FROM FIRE_STATION
        WHERE AREA IS NOT NULL
          AND UPPER(AREA) LIKE '%' || UPPER(#{q}) || '%'
        GROUP BY AREA
        ORDER BY MIN(STATION_NO)
        FETCH FIRST 10 ROWS ONLY
    </select>
    
    
    <!-- 필수 기능 아님 ( 추후 구현 ) -->
    <!-- 8) 자동완성 - 소방서명 -->
    <select id="suggestStation" parameterType="string" resultType="string">
        SELECT STATION_NM
        FROM FIRE_STATION
        WHERE STATION_NM IS NOT NULL
          AND UPPER(STATION_NM) LIKE '%' || UPPER(#{q}) || '%'
        GROUP BY STATION_NM
        ORDER BY MIN(STATION_NO)
        FETCH FIRST 10 ROWS ONLY
    </select>

    <!-- 9) 지역 기준 목록 -->
    <select id="listByArea" parameterType="string" resultMap="FireStationResultMap">
        SELECT <include refid="firestationColumns"/>
        FROM FIRE_STATION
        WHERE UPPER(AREA) LIKE '%' || UPPER(#{area}) || '%'
        ORDER BY AREA, STATION_NM
    </select>
    
     <!-- 시/군/구 기준 소방서 개수 조회 -->
    <select id="firestationCount" resultType="map">
        SELECT 
            CASE 
                WHEN REGEXP_LIKE(AREA, '군') 
                    THEN REGEXP_SUBSTR(AREA, '^[^ ]+ [^ ]+ 군')
                WHEN REGEXP_LIKE(AREA, '구') 
                    THEN REGEXP_SUBSTR(AREA, '^[^ ]+ [^ ]+ 구')
                ELSE REGEXP_SUBSTR(AREA, '^[^ ]+ [^ ]+')
            END AS REGION,
            COUNT(*) AS FIRE_STATION_CNT
        FROM FIRE_STATION
        GROUP BY 
            CASE 
                WHEN REGEXP_LIKE(AREA, '군') 
                    THEN REGEXP_SUBSTR(AREA, '^[^ ]+ [^ ]+ 군')
                WHEN REGEXP_LIKE(AREA, '구') 
                    THEN REGEXP_SUBSTR(AREA, '^[^ ]+ [^ ]+ 구')
                ELSE REGEXP_SUBSTR(AREA, '^[^ ]+ [^ ]+')
            END
        ORDER BY FIRE_STATION_CNT DESC
    </select>

</mapper>
