<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- Î∞òÎìúÏãú Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ FQNÍ≥º ÎèôÏùº -->
<mapper namespace="com.pcwk.ehr.mapper.LandslideMapper">

  <!-- =========================================================
       DTO Îß§Ìïë: com.pcwk.ehr.domain.LandslideDTO
       ÌïÑÎìú:
         - int     lndApntCd
         - String  lndApntNm
         - String  lndApntStts
         - String  lndApntDt
         - String  lndInstNm
         - double  lat
         - double  lon
         - Integer landslideNo
       ========================================================= -->
  <resultMap id="LandslideResultMap" type="com.pcwk.ehr.domain.LandslideDTO">
    <id     property="landslideNo" column="LANDSLIDE_NO"/>
    <result property="lndApntCd"   column="LND_APNT_CD"/>
    <result property="lndApntNm"   column="LND_APNT_NM"/>
    <result property="lndApntStts" column="LND_APNT_STTS"/>
    <result property="lndApntDt"   column="LND_APNT_DT"/>
    <result property="lndInstNm"   column="LND_INST_NM"/>
    <result property="lat"         column="LAT"/>
    <result property="lon"         column="LON"/>
  </resultMap>

  <!-- =========================================================
       1) BBox ÎÇ¥ Ìè¨Ïù∏Ìä∏(Îã®Í±¥) Î™©Î°ù Ï°∞Ìöå
       ÌååÎùºÎØ∏ÌÑ∞: minLat, maxLat, minLon, maxLon, q
       Ï†ïÎ†¨: Î∞úÏÉùÏùºÏãú ÏµúÏã†Ïàú -> PK Ïó≠Ïàú
       ========================================================= -->
  <select id="selectByBBox" resultMap="LandslideResultMap">
    SELECT
           L.LANDSLIDE_NO,
           L.LND_APNT_CD,
           L.LND_APNT_NM,
           L.LND_APNT_STTS,
           L.LND_APNT_DT,
           L.LND_INST_NM,
           L.LAT,
           L.LON
      FROM LANDSLIDE L
     WHERE L.LAT BETWEEN #{minLat} AND #{maxLat}
       AND L.LON BETWEEN #{minLon} AND #{maxLon}
    <if test="q != null and q != ''">
       AND (
            L.LND_INST_NM   LIKE '%' || #{q} || '%'
         OR L.LND_APNT_NM   LIKE '%' || #{q} || '%'
         OR L.LND_APNT_STTS LIKE '%' || #{q} || '%'
       )
    </if>
     ORDER BY L.LND_APNT_DT DESC NULLS LAST,
              L.LANDSLIDE_NO DESC
  </select>

  <!-- =========================================================
       2) Îã®Í±¥ ÏÉÅÏÑ∏
       ÌååÎùºÎØ∏ÌÑ∞: landslideNo
       ========================================================= -->
  <select id="findById" resultMap="LandslideResultMap">
    SELECT
           L.LANDSLIDE_NO,
           L.LND_APNT_CD,
           L.LND_APNT_NM,
           L.LND_APNT_STTS,
           L.LND_APNT_DT,
           L.LND_INST_NM,
           L.LAT,
           L.LON
      FROM LANDSLIDE L
     WHERE L.LANDSLIDE_NO = #{landslideNo}
  </select>

  <!-- =========================================================
       3) BBox ÎÇ¥ "ÏãúÍµ∞Íµ¨/ÏßÄÏó≠Î™Ö" ÏßëÍ≥Ñ (Î≤ÑÎ∏îÏö©)
       - ÌñâÏ†ïÍµ¨Ïó≠ Î≥¥Ï°∞ÌÖåÏù¥Î∏î ÏóÜÏù¥ LND_INST_NM Í∏∞Ï§Ä Í∑∏Î£πÌïë
       - Î≤ÑÎ∏î Ï¢åÌëú: Ìï¥Îãπ Í∑∏Î£π Ìè¨Ïù∏Ìä∏Ïùò ÌèâÍ∑† Ï¢åÌëú(Í∞ÑÏù¥ Ï§ëÏã¨)
       Î∞òÌôò ÌÇ§(Îî∞Ïò¥Ìëú aliasÎ°ú Map ÌÇ§ Í≥†Ï†ï):
         "regionName", "lat", "lon", "cnt"
       ========================================================= -->
  <select id="countByRegionInBBox" resultType="map">
    SELECT
           L.LND_INST_NM        AS "regionName",
           AVG(L.LAT)           AS "lat",
           AVG(L.LON)           AS "lon",
           COUNT(*)             AS "cnt"
      FROM LANDSLIDE L
     WHERE L.LAT BETWEEN #{minLat} AND #{maxLat}
       AND L.LON BETWEEN #{minLon} AND #{maxLon}
    <if test="q != null and q != ''">
       AND (
            L.LND_INST_NM   LIKE '%' || #{q} || '%'
         OR L.LND_APNT_NM   LIKE '%' || #{q} || '%'
         OR L.LND_APNT_STTS LIKE '%' || #{q} || '%'
       )
    </if>
     GROUP BY L.LND_INST_NM
     ORDER BY "cnt" DESC, "regionName"
  </select>

  <!-- =========================================================
       4) BBox ÎÇ¥ "Ïãú/ÎèÑ" ÏßëÍ≥Ñ (Ï§åÏïÑÏõÉ Î≤ÑÎ∏î)
       - ÏßÄÏó≠Î™Ö Í∑úÏπôÏóê ÎßûÏ∂∞ ÏÉÅÏúÑ ÌñâÏ†ïÍµ¨Ïó≠Îßå Ï∂îÏ∂ú
       - Ïòà: 'Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ Í∞ïÎ¶âÏãú' ÌòïÌÉúÎ©¥ SUBSTR/REGEXPÏúºÎ°ú ÏïûÎ∂ÄÎ∂ÑÎßå
       - ÏïÑÎûò ÏòàÏãúÎäî Í∞ÑÎã®Ìûà Ï≤´ Îëê Í∏ÄÏûêÎ•º Ïãú/ÎèÑÎ°ú Í∞ÄÏ†ï(ÌîÑÎ°úÏ†ùÌä∏ Í∑úÏπôÏóê ÎßûÍ≤å ÏàòÏ†ï)
       Î∞òÌôò ÌÇ§:
         "sidoNm", "lat", "lon", "cnt"
       ========================================================= -->
  <select id="countBySidoInBBox" resultType="map">
    SELECT
           /* üëá Ïã§Ï†ú Î™ÖÎ™Ö Í∑úÏπôÏóê ÎßûÍ≤å ÍµêÏ≤¥ Í∂åÏû• */
           SUBSTR(L.LND_INST_NM, 1, 2) AS "sidoNm",
           AVG(L.LAT)                  AS "lat",
           AVG(L.LON)                  AS "lon",
           COUNT(*)                    AS "cnt"
      FROM LANDSLIDE L
     WHERE L.LAT BETWEEN #{minLat} AND #{maxLat}
       AND L.LON BETWEEN #{minLon} AND #{maxLon}
    <if test="q != null and q != ''">
       AND (
            L.LND_INST_NM   LIKE '%' || #{q} || '%'
         OR L.LND_APNT_NM   LIKE '%' || #{q} || '%'
         OR L.LND_APNT_STTS LIKE '%' || #{q} || '%'
       )
    </if>
     GROUP BY SUBSTR(L.LND_INST_NM, 1, 2)
     ORDER BY "cnt" DESC, "sidoNm"
  </select>

    
     <!-- ÎÖÑÎèÑÎ≥Ñ ÌÜµÍ≥Ñ -->
    <select id="selectByYear" resultType="map">
        SELECT 
            TO_CHAR(TO_DATE(LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY') AS year,
            COUNT(*) AS total_count
        FROM LANDSLIDE
        GROUP BY TO_CHAR(TO_DATE(LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY')
        ORDER BY year
    </select>

    <!-- ÏßÄÏó≠Î≥Ñ ÌÜµÍ≥Ñ -->
    <select id="selectByRegion" resultType="map">
        SELECT SUBSTR(LND_INST_NM, 1, INSTR(LND_INST_NM, ' ') - 1) AS region,
		       COUNT(*) AS total_count
		FROM LANDSLIDE
		GROUP BY SUBSTR(LND_INST_NM, 1, INSTR(LND_INST_NM, ' ') - 1)
		ORDER BY total_count DESC
    </select>

    <!-- ÏõîÎ≥Ñ ÌÜµÍ≥Ñ -->
    <select id="selectByMonth" resultType="map">
        SELECT 
            TO_CHAR(TO_DATE(LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM') AS month,
            COUNT(*) AS total_count
        FROM LANDSLIDE
        GROUP BY TO_CHAR(TO_DATE(LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM')
        ORDER BY month
    </select>

    <!-- Ï£ºÏùòÎ≥¥/Í≤ΩÎ≥¥ Îì± ÏòàÎ≥¥ ÏÉÅÌÉúÎ≥Ñ ÌÜµÍ≥Ñ -->
    <select id="selectByStatus" resultType="map">
        SELECT 
            LND_APNT_NM AS status,
            COUNT(*) AS total_count
        FROM LANDSLIDE
        GROUP BY LND_APNT_NM
        ORDER BY LND_APNT_NM DESC
    </select>
</mapper>
