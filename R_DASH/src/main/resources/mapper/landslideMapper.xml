<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 반드시 인터페이스 FQN과 동일 -->
<mapper namespace="com.pcwk.ehr.mapper.LandslideMapper">

  <!-- =========================================================
       DTO 매핑: com.pcwk.ehr.domain.LandslideDTO
       필드:
         - int     lndApntCd
         - String  lndApntNm
         - String  lndApntStts
         - String  lndApntDt
         - String  lndInstNm
         - double  lat
         - double  lon
         - Integer landslideNo
       ========================================================= -->
  <resultMap id="LandslideResultMap" type="com.pcwk.ehr.domain.LandslideDTO">
    <id     property="landslideNo" column="LANDSLIDE_NO"/>
    <result property="lndApntCd"   column="LND_APNT_CD"/>
    <result property="lndApntNm"   column="LND_APNT_NM"/>
    <result property="lndApntStts" column="LND_APNT_STTS"/>
    <result property="lndApntDt"   column="LND_APNT_DT"/>
    <result property="lndInstNm"   column="LND_INST_NM"/>
    <result property="lat"         column="LAT"/>
    <result property="lon"         column="LON"/>
  </resultMap>


 <!-- LANDSLIDE.xml -->
<select id="countByRegionInBBox" resultType="map">
  SELECT
    LND_INST_NM         AS name,
    CAST(LAT AS NUMBER) AS lat,
    CAST(LON AS NUMBER) AS lon,
    COUNT(*)            AS cnt
  FROM LANDSLIDE
  WHERE LAT BETWEEN #{minLat} AND #{maxLat}
    AND LON BETWEEN #{minLon} AND #{maxLon}
    <if test="q != null and q != ''">
      AND (LND_INST_NM LIKE '%' || #{q} || '%')
    </if>
    <if test="year != null and year != ''">
      AND TO_CHAR(LND_APNT_DT, 'YYYY') = #{year}
    </if>
    -- 필요하면 상태 필터도: AND LND_APNT_STTS = '발령'
  GROUP BY LND_INST_NM, LAT, LON
</select>

<select id="selectByBBox" resultType="com.pcwk.ehr.domain.LandslideDTO">
  SELECT /* 필요한 칼럼만 */
    LND_APNT_CD, LND_APNT_NM, LND_APNT_STTS, LND_APNT_DT,
    LND_INST_NM, LAT, LON
  FROM LANDSLIDE
  WHERE LAT BETWEEN #{minLat} AND #{maxLat}
    AND LON BETWEEN #{minLon} AND #{maxLon}
    <if test="q != null and q != ''">
      AND (LND_INST_NM LIKE '%' || #{q} || '%')
    </if>
    <if test="year != null and year != ''">
      AND TO_CHAR(LND_APNT_DT, 'YYYY') = #{year}
    </if>
</select>

<select id="countBySidoInBBox" resultType="map">
  SELECT
    REGEXP_SUBSTR(LND_INST_NM, '^[^ ]+') AS sido,
    COUNT(*) AS cnt
  FROM LANDSLIDE
  WHERE LAT BETWEEN #{minLat} AND #{maxLat}
    AND LON BETWEEN #{minLon} AND #{maxLon}
    <if test="q != null and q != ''">
      AND (LND_INST_NM LIKE '%' || #{q} || '%')
    </if>
    <if test="year != null and year != ''">
      AND TO_CHAR(LND_APNT_DT, 'YYYY') = #{year}
    </if>
  GROUP BY REGEXP_SUBSTR(LND_INST_NM, '^[^ ]+')
</select>
 
    
    
     <!-- 년도별 통계 -->
    <select id="selectByYear" resultType="map">
        SELECT 
            TO_CHAR(TO_DATE(LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY') AS year,
            COUNT(*) AS total_count
        FROM LANDSLIDE
        GROUP BY TO_CHAR(TO_DATE(LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY')
        ORDER BY year
    </select>

    <!-- 지역별 통계 -->
    <select id="selectByRegion" resultType="map">
        SELECT SUBSTR(LND_INST_NM, 1, INSTR(LND_INST_NM, ' ') - 1) AS region,
               COUNT(*) AS total_count
        FROM LANDSLIDE
        GROUP BY SUBSTR(LND_INST_NM, 1, INSTR(LND_INST_NM, ' ') - 1)
        ORDER BY total_count DESC
    </select>

    <!-- 월별 통계 -->
    <select id="selectByMonth" resultType="map">
        SELECT 
            TO_CHAR(TO_DATE(LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS'), 'MM') AS month,
            COUNT(*) AS total_count
        FROM LANDSLIDE
        GROUP BY TO_CHAR(TO_DATE(LND_APNT_DT, 'YYYY-MM-DD HH24:MI:SS'), 'MM')
        ORDER BY month
    </select>

    <!-- 주의보/경보 등 예보 상태별 통계 -->
    <select id="selectByStatus" resultType="map">
        SELECT 
            LND_APNT_NM AS status,
            COUNT(*) AS total_count
        FROM LANDSLIDE
        GROUP BY LND_APNT_NM
        ORDER BY LND_APNT_NM DESC
    </select>
</mapper>