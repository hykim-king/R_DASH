<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.mapper.SinkholeMapper">

  <select id="selectAll" resultType="com.pcwk.ehr.domain.SinkholeDTO">
    SELECT SINKHOLE_NO AS sinkholeNo, SIDO_NM AS sidoNm, SIGNGU_NM AS signguNm,
           LAT, LON, TO_CHAR(OCCUR_DT,'YYYY-MM-DD') AS occurDt, STATE_NM AS stateNm
    FROM SINKHOLE
    ORDER BY OCCUR_DT DESC, SINKHOLE_NO DESC
  </select>

  <select id="selectByBBox" resultType="com.pcwk.ehr.domain.SinkholeDTO">
    SELECT SINKHOLE_NO AS sinkholeNo, SIDO_NM AS sidoNm, SIGNGU_NM AS signguNm,
           LAT, LON, TO_CHAR(OCCUR_DT,'YYYY-MM-DD') AS occurDt, STATE_NM AS stateNm
    FROM SINKHOLE
    WHERE LAT BETWEEN #{minLat} AND #{maxLat}
      AND LON BETWEEN #{minLon} AND #{maxLon}
    ORDER BY OCCUR_DT DESC, SINKHOLE_NO DESC
  </select>

  <select id="findById" resultType="com.pcwk.ehr.domain.SinkholeDTO">
    SELECT SINKHOLE_NO AS sinkholeNo, SIDO_NM AS sidoNm, SIGNGU_NM AS signguNm,
           LAT, LON, TO_CHAR(OCCUR_DT,'YYYY-MM-DD') AS occurDt, STATE_NM AS stateNm
    FROM SINKHOLE
    WHERE SINKHOLE_NO = #{sinkholeNo}
  </select>

  <select id="countByState" resultType="map">
    SELECT NVL(STATE_NM, 'UNKNOWN') AS STATE_NM,
           COUNT(*)                 AS CNT
    FROM SINKHOLE
    GROUP BY STATE_NM
    ORDER BY CNT DESC
  </select>
  
  <!-- 년도별 발생 횟수 -->
  <select id="selectYearlyCounts" resultType="map">
    SELECT
      TO_CHAR(OCCUR_DT, 'YYYY') AS YEAR,
      COUNT(*) AS CNT
    FROM SINKHOLE
    GROUP BY TO_CHAR(OCCUR_DT, 'YYYY')
    ORDER BY YEAR
  </select>

  <!-- 지역별 발생 횟수 (시도 단위) -->
  <select id="selectSignguCounts" resultType="map">
    SELECT
      SIDO_NM AS SIDO_NM,
      COUNT(*)  AS CNT
    FROM SINKHOLE
    GROUP BY SIDO_NM
    ORDER BY SIDO_NM
  </select>

  <!-- 월별 발생 횟수 -->
  <select id="selectMonthlyCounts" resultType="map">
    SELECT
      TO_CHAR(OCCUR_DT, 'MM') AS MONTH,
      COUNT(*) AS CNT
    FROM SINKHOLE
    GROUP BY TO_CHAR(OCCUR_DT, 'MM')
    ORDER BY TO_NUMBER(MONTH)
  </select>

  <!-- 년도별 피해 통계 -->
  <select id="selectYearlyDamageStats" resultType="map">
    SELECT
      TO_CHAR(OCCUR_DT, 'YYYY') AS YEAR,
      SUM(NVL(DPRS_CNT,   0)) AS DPRS_TOT,
      SUM(NVL(INJPSN_CNT, 0)) AS INJ_TOT,
      SUM(NVL(VEHCLE_CNT, 0)) AS VEH_TOT
    FROM SINKHOLE
    GROUP BY TO_CHAR(OCCUR_DT, 'YYYY')
    ORDER BY YEAR
  </select>

</mapper>
