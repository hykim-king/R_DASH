<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.mapper.newsMapper">
    <insert id="saveALl">
        
    </insert>
    
    <select id="getCount" resultType="java.lang.Integer">
        SELECT COUNT(*) cnt FROM NEWS
    </select>

    <delete id="deleteAll">
        DELETE FROM NEWS
    </delete>
    
    <select id="doRetrieve" parameterType="NewsDTO" resultType="NewsDTO">
        SELECT
		    news_no,
		    keyword,
		    title,
		    company,
		    url,
		    pub_dt,
		    reg_dt
		FROM
		    news
		WHERE (TRUNC(reg_dt) = TRUNC(SYSDATE))AND keyword=#{keyword}
		ORDER BY reg_dt DESC;
    </select>
    
    <update id="doUpdate" parameterType="NewsDTO">
        MERGE INTO NEWS t1
		USING (
		        SELECT
		        #{newsNo} AS news_no,
		        #{keyword} AS keyword,
		        #{title} AS title,
		        #{company} AS company,
		        #{url} AS url,
		        #{pubDt} AS pub_dt,
		        SYSDATE AS reg_dt
		        FROM
		            dual)t2
		ON (t1.url = t2.url)
		WHEN MATCHED THEN 
		    UPDATE SET
		            t1.keyword = t2.keyword,
		            t1.title = t2.title,
		            t1.company = t2.company,
		            t1.pub_dt =t2.pub_dt,
		            t1.reg_dt =t2.reg_dt
		WHEN NOT MATCHED THEN
		    INSERT (news_no,keyword,title,company,url,pub_dt,reg_dt)
		    VALUES ( t2.news_no,t2.keyword,t2.title,t2.company,t2.url,t2.pub_dt,t2.reg_dt); 
    </update>

    <insert id="doSave" parameterType="NewsDTO" 
					  useGeneratedKeys="true" 
					  keyProperty="newsNo" 
					  keyColumn="NEWS_NO">
        INSERT INTO news (
		    keyword,
		    title,
		    company,
		    url,
		    pub_dt,
		    reg_dt
		) VALUES ( #{keyword},
		           #{title},
		           #{company},
		           #{url},
		           #{pubDt},
		           SYSDATE )
    </insert>
</mapper>