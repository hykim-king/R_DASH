<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.mapper.NowcastMapper">

  <!-- DTO 매핑: 네가 쓰는 NowcastDTO 필드 그대로 -->
  <resultMap id="NowcastMap" type="com.pcwk.ehr.domain.NowcastDTO">
    <id     column="NOWCAST_NO" property="nowcastNo"/>
    <result column="BASE_DATE"  property="baseDate"/>
    <result column="BASE_TIME"  property="baseTime"/>
    <result column="SIDO_NM"    property="sidoNm"/>
    <result column="SIGNGU_NM"  property="signguNm"/>
    <result column="NX"         property="nx"/>
    <result column="NY"         property="ny"/>
    <result column="CATEGORY"   property="category"/>
    <result column="OBSR_VALUE" property="obsrValue"/>
  </resultMap>

  <!-- 지도 색칠용: 단일 카테고리 전국 최신 스냅샷 -->
  <resultMap id="NowcastNationRow" type="map">
    <result property="sidoNm"     column="SIDO_NM"/>
    <result property="signguNm"   column="SIGNGU_NM"/>
    <result property="obsrValue"  column="OBSR_VALUE"/>
  </resultMap>

  <!-- 1) /nowcast/latest.do?category=T1H | RN1 | REH | WSD -->
  <select id="selectNationLatest" resultMap="NowcastNationRow">
    WITH ranked AS (
      SELECT
        SIDO_NM,
        SIGNGU_NM,
        OBSR_VALUE AS OBSR_VALUE,
        ROW_NUMBER() OVER (
          PARTITION BY SIDO_NM, SIGNGU_NM, TRIM(UPPER(CATEGORY))
          ORDER BY BASE_DATE DESC,
                   TO_NUMBER(LPAD(TRIM(BASE_TIME), 4, '0')) DESC,
                   NOWCAST_NO DESC
        ) AS RN
      FROM NOWCAST
      WHERE TRIM(UPPER(CATEGORY)) = TRIM(UPPER(#{category}))
    )
    SELECT SIDO_NM, SIGNGU_NM, OBSR_VALUE
    FROM ranked
    WHERE RN = 1
    ORDER BY SIDO_NM, SIGNGU_NM
  </select>

  <!-- 2) 전국: 모든 시군구 × 4카테고리 최신값(지역당 4행) -->
  <select id="selectLatest4All" resultMap="NowcastMap">
    WITH base AS (
      SELECT
        NOWCAST_NO, BASE_DATE, BASE_TIME,
        SIDO_NM, SIGNGU_NM, NX, NY,
        CATEGORY, OBSR_VALUE,
        ( BASE_DATE
          + NUMTODSINTERVAL(SUBSTR(BASE_TIME,1,2), 'HOUR')
          + NUMTODSINTERVAL(SUBSTR(BASE_TIME,3,2), 'MINUTE')
        ) AS TS
      FROM NOWCAST
      WHERE TRIM(UPPER(CATEGORY)) IN ('T1H','RN1','REH','WSD')
    ),
    latest AS (
      SELECT
        NOWCAST_NO, BASE_DATE, BASE_TIME,
        SIDO_NM, SIGNGU_NM, NX, NY,
        CATEGORY, OBSR_VALUE, TS,
        ROW_NUMBER() OVER (
          PARTITION BY SIDO_NM, SIGNGU_NM, CATEGORY
          ORDER BY TS DESC
        ) rn
      FROM base
    ),
    regions AS (SELECT DISTINCT SIDO_NM, SIGNGU_NM FROM NOWCAST),
    cats AS (
      SELECT 'T1H' AS CATEGORY FROM dual UNION ALL
      SELECT 'RN1'             FROM dual UNION ALL
      SELECT 'REH'             FROM dual UNION ALL
      SELECT 'WSD'             FROM dual
    )
    SELECT
      r.SIDO_NM                           AS SIDO_NM,
      r.SIGNGU_NM                         AS SIGNGU_NM,
      c.CATEGORY                          AS CATEGORY,
      NVL(l.NOWCAST_NO, 0)                AS NOWCAST_NO,
      CASE WHEN l.BASE_DATE IS NOT NULL
           THEN TO_CHAR(l.BASE_DATE,'YYYYMMDD')
           ELSE NULL
      END                                  AS BASE_DATE,
      l.BASE_TIME                          AS BASE_TIME,
      NVL(l.NX,0)                          AS NX,
      NVL(l.NY,0)                          AS NY,
      NVL(l.OBSR_VALUE,0)                  AS OBSR_VALUE
    FROM regions r
    CROSS JOIN cats c
    LEFT JOIN latest l
      ON l.rn = 1
     AND l.SIDO_NM   = r.SIDO_NM
     AND l.SIGNGU_NM = r.SIGNGU_NM
     AND l.CATEGORY  = c.CATEGORY
    ORDER BY r.SIDO_NM, r.SIGNGU_NM, c.CATEGORY
  </select>

  <!-- 3) 특정 시군구: 4카테고리 최신값(항상 4행) -->
  <select id="selectLatest4ByRegion" resultMap="NowcastMap">
    WITH base AS (
      SELECT
        NOWCAST_NO, BASE_DATE, BASE_TIME,
        SIDO_NM, SIGNGU_NM, NX, NY,
        CATEGORY, OBSR_VALUE,
        ( BASE_DATE
          + NUMTODSINTERVAL(SUBSTR(BASE_TIME,1,2), 'HOUR')
          + NUMTODSINTERVAL(SUBSTR(BASE_TIME,3,2), 'MINUTE')
        ) AS TS
      FROM NOWCAST
      WHERE TRIM(UPPER(CATEGORY)) IN ('T1H','RN1','REH','WSD')
        AND SIDO_NM   = #{sidoNm}
        AND SIGNGU_NM = #{signguNm}
    ),
    latest AS (
      SELECT
        NOWCAST_NO, BASE_DATE, BASE_TIME,
        SIDO_NM, SIGNGU_NM, NX, NY,
        CATEGORY, OBSR_VALUE, TS,
        ROW_NUMBER() OVER (
          PARTITION BY SIDO_NM, SIGNGU_NM, CATEGORY
          ORDER BY TS DESC
        ) rn
      FROM base
    ),
    cats AS (
      SELECT 'T1H' AS CATEGORY FROM dual UNION ALL
      SELECT 'RN1'             FROM dual UNION ALL
      SELECT 'REH'             FROM dual UNION ALL
      SELECT 'WSD'             FROM dual
    )
    SELECT
      #{sidoNm}    AS SIDO_NM,
      #{signguNm}  AS SIGNGU_NM,
      c.CATEGORY   AS CATEGORY,
      NVL(l.NOWCAST_NO, 0) AS NOWCAST_NO,
      CASE WHEN l.BASE_DATE IS NOT NULL
           THEN TO_CHAR(l.BASE_DATE,'YYYYMMDD')
           ELSE NULL
      END          AS BASE_DATE,
      l.BASE_TIME  AS BASE_TIME,
      NVL(l.NX,0)  AS NX,
      NVL(l.NY,0)  AS NY,
      NVL(l.OBSR_VALUE,0) AS OBSR_VALUE
    FROM cats c
    LEFT JOIN latest l
      ON l.rn = 1
     AND l.CATEGORY = c.CATEGORY
    ORDER BY c.CATEGORY
  </select>

</mapper>
