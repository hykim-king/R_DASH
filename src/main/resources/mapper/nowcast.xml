<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.mapper.NowcastMapper">

<resultMap id="NowcastMap" type="com.pcwk.ehr.domain.NowcastDTO">
    <result property="sidoNm" column="SIDO_NM"/>
    <result property="sigunguNm" column="SIGNGU_NM"/>
    <result property="category" column="CATEGORY"/>
    <result property="obsrValue" column="OBSR_VALUE"/>
    <result property="baseDate" column="BASE_DATE"/>
    <result property="baseTime" column="BASE_TIME"/>
</resultMap>


<!-- 최신 “공통 시각” -->
<select id="selectLatestCommonBase" resultType="map">
    SELECT TO_CHAR(BASE_DATE, 'YYYYMMDD') AS BASE_DATE,
           TO_CHAR(BASE_TIME, 'FM0000')   AS BASE_TIME
    FROM NOWCAST
    WHERE CATEGORY IN ('T1H','RN1','WSD','REH')
    GROUP BY BASE_DATE, BASE_TIME
    ORDER BY BASE_DATE DESC, BASE_TIME DESC
    FETCH FIRST 1 ROWS ONLY
</select>



  <!-- 2) 특정 시각의 전국 데이터 -->
  <select id="selectNowcastByBase"
          parameterType="map"
          resultType="com.pcwk.ehr.domain.NowcastDTO">
    SELECT SIDO_NM,
           SIGNGU_NM,
           CATEGORY,
           OBSR_VALUE,
           TO_CHAR(BASE_DATE, 'RR/MM/DD') AS BASE_DATE,
           TO_CHAR(BASE_TIME)             AS BASE_TIME
    FROM NOWCAST
    WHERE BASE_DATE = #{baseDate}
      AND BASE_TIME = #{baseTime}
      AND CATEGORY IN ('T1H','RN1','WSD','REH')
    ORDER BY SIDO_NM, SIGNGU_NM, CATEGORY
  </select>

  <select id="selectNowcastByRegion"
        parameterType="map"
        resultMap="NowcastMap">
    SELECT SIDO_NM,
           SIGNGU_NM,
           CATEGORY,
           OBSR_VALUE,
           BASE_DATE,
           BASE_TIME
    FROM NOWCAST
    WHERE BASE_DATE = #{baseDate}
      AND BASE_TIME = #{baseTime}
      AND SIDO_NM = #{sidoNm}
      AND SIGNGU_NM = #{signguNm}
      AND CATEGORY IN ('T1H','RN1','WSD','REH')
    ORDER BY CATEGORY
</select>

</mapper>
