<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- FIRE_STATION Mapper -->
<mapper namespace="com.pcwk.ehr.mapper.ShelterMapper">
  <!-- DTO 매핑 -->
  <resultMap id="ShelterMap" type="com.pcwk.ehr.domain.ShelterDTO">
    <id     property="shelterNo" column="SHELTER_NO"/>
    <result property="reareNm"   column="REARE_NM"/>
    <result property="ronaDaddr" column="RONA_DADDR"/>
    <result property="lat"       column="LAT"/>
    <result property="lon"       column="LON"/>
    <result property="shltCd"    column="SHLT_CD"/>
    <result property="shltNm"    column="SHLT_NM"/>
  </resultMap>


  <!-- 공통 컬럼 묶음 -->
  <sql id="ShelterColumns">
    SHELTER_NO,
    REARE_NM,
    RONA_DADDR,
    LAT,
    LON,
    SHLT_CD,
    SHLT_NM
  </sql>



  <!-- 1) 전체 목록 -->
  <select id="selectAll" resultMap="ShelterMap">
    SELECT
      <include refid="ShelterColumns"/>
    FROM SHELTER
    ORDER BY SHELTER_NO
  </select>

    <!-- 2) 단건 조회 -->
    <select id="findById" parameterType="int" resultMap="ShelterMap">
        SELECT <include refid="ShelterColumns"/>
        FROM SHELTER
        WHERE SHELTER_NO = #{shelterNo}
    </select>


  <!-- 3) 자동완성: 시설명(또는 주소) -->
  <!-- ShelterMapper.java에 suggestStation(@Param("q") String q) 이므로 id 같게 -->
  <select id="suggestStation" parameterType="string" resultType="string">
    SELECT DISTINCT REARE_NM
    FROM SHELTER
    <where>
      <if test="q != null and q != ''">
        ( REARE_NM   LIKE '%' || #{q} || '%'
          OR RONA_DADDR LIKE '%' || #{q} || '%' )
      </if>
    </where>
    ORDER BY REARE_NM
    FETCH FIRST 10 ROWS ONLY
  </select>



  <!-- 3) 지도 BBox + 키워드 -->
  <select id="selectByBBox"
          resultMap="ShelterMap"
          parameterType="map">
    SELECT
      <include refid="ShelterColumns"/>
    FROM SHELTER
    <where>
      LAT &gt;= #{minLat}
      AND LAT &lt;= #{maxLat}
      AND LON &gt;= #{minLon}
      AND LON &lt;= #{maxLon}
      <if test="q != null and q != ''">
        AND (
              REARE_NM   LIKE '%' || #{q} || '%'
           OR RONA_DADDR LIKE '%' || #{q} || '%'
           OR SHLT_NM    LIKE '%' || #{q} || '%'
        )
      </if>
    </where>
    ORDER BY REARE_NM
  </select>
  

  
  
    <!-- 9) 지역 기준 목록 -->
    <select id="listByArea" parameterType="string" resultMap="ShelterMap">
        SELECT <include refid="ShelterColumns"/>
        FROM SHELTER
        WHERE UPPER(RONA_DADDR) LIKE '%' || UPPER(#{ronaDaddr}) || '%'
        ORDER BY RONA_DADDR, REARE_NM
    </select>

</mapper>
